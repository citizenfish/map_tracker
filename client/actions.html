<script id="init" type="text/html">
    <!-- init is always run automatically on startup -->
    @templates.render({"targetId": "#overlayContainer","template": "#loading"},{"queueRun": "Instant"});
    @templates.render({"targetId": "#content","template": "#basic"},{"queueRun": "Instant"});
    -openlayers.addMap({"center":[-327078.93,7341533.72],"zoom":6});
    -openlayers.addLayer({"name":"osm","type":"osm"});
    -openlayers.addLayer({"name":"route","type":"vector","style":"styles.reportStyle"});
    -openlayers.addLayer({"name":"spotPoints","type":"vector","style":"styles.reportStyle"});
    -openlayers.addLayer({"name":"schoolPoints","type":"vector","style":"styles.schoolStyle"});
    -internals.setMemory({"name":"filters", "value":["school","workplace"], "mode": "Session"});
    -input.initialiseFilterList({});
    {{#include #getRoute}}
    {{#include #getSpotPoints}}
    {{#include #getLeaders}}
    {{#include #getSchools}}
    -templates.render({"targetId": "#overlayContainer", "template": "#empty"},{"queueRun": "Instant"});
    {{#include #updatePoints}}
    {{#include #updateLoop}}
</script>

<script id="empty" type="text/html">

</script>

<script id="loading" type="text/html">
    <div id="loadingScreen">
        <div class="lds-dual-ring"></div>
    </div>
</script>

<script id="basic" type="text/html">
    <div id="map"></div>
    <div id="leaderboard" class="list">
        <div id="filters">
            <button id="filter-expand" @elements.toggleClass({"targetId":"#filter-list","class":"hidden"},{"queueEvent":"mousedown"});>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
            </button>
            <div id="filter-list" class="card filter-card hidden">
                <div class="list">
                    <div class="list-item"
                        @elements.toggleClass({"targetId":"#schoolsSVG","class":"hidden-svg"},{"queueEvent":"mousedown"});
                        -input.updateFilters({"value":"school"});
                        -internals.execute({"name":"updatePoints"});
                    >
                        <span class="checkbox">
                            <svg id="schoolsSVG" class="checkbox-svg" focusable="false" viewBox="2 2 20 20" aria-hidden="true" role="presentation"><path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>
                        </span>
                        <span>Schools</span>
                    </div>

                    <div class="list-item"
                        @elements.toggleClass({"targetId":"#workplaceSVG","class":"hidden-svg"},{"queueEvent":"mousedown"});
                        -input.updateFilters({"value":"workplace"});
                        -internals.execute({"name":"updatePoints"});
                    >
                        <span class="checkbox">
                            <svg id="workplaceSVG" class="checkbox-svg" focusable="false" viewBox="2 2 20 20" aria-hidden="true" role="presentation"><path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>
                        </span>
                        <span>Workplace</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="list-title">
            <span class="title">Leaderboard</span>
            <div id="menu">
                <button id="menu-toggle" @elements.addClass({"targetId":"#side-menu","class":"menu-open"},{"queueEvent":"mousedown"});><</button>
                <div id="side-menu" class="card side-menu">
                    <div class="menu-topper">
                        <button class="remove-shadow hide-button" @elements.removeClass({"targetId":"#side-menu","class":"menu-open"},{"queueEvent":"mousedown"});>X</button>
                    </div>
                    <div class="menu-item">About</div>
                    <div class="menu-item">Register</div>
                    <div class="menu-item" @templates.render({"targetId": "#overlayContainer","template": "#mileageDialog"});>Add miles</div>
                    <div class="menu-item">Contact us</div>
                </div>
            </div>
        </div>
        <div id="list"></div>
    </div>
</script>

<script id="leaderboardItem" type="text/html">
    <div class="list-item" @elements.addClass({"targetId":"#side-menu","class":"menu-open"},{"queueEvent":"mousedown"});>
        <span>test text</span>
    </div>
</script>

<script id="getLeaders" type="text/html">
    -api.post({
        "url": "{{config.api}}",
        "body":{
            "_token":"{{config.token}}",
            "schema":"adventuresyndicate",
            "app":"map_tracker",
            "api": "reporting_api",
            "action": "run_report",
            "payload":{
                "report_name":"leaderboard",
                "_filters": [
                    "{{!^memory.filterList}}"
                ]
            }
        }
    }, {
        "memoryMode":"Session","memoryName":"leaderboard"
    });
    -loop.multi({"targetId":"#list","template":"#leaderboardItem","data":"{{!^JSON.stringify(memory.leaderboard.value.API.Response)}}"});
</script>

<script id="getRoute" type="text/ourthings">
    -api.post({"url":"{{config.api}}","body":{"_token":"{{config.token}}","schema":"adventuresyndicate","app":"map_tracker", "api": "feature_api", "action": "get_geojson", "payload": {"_filters":[{"type": "json", "data": "features", "item": "attributes", "prefix": "F", "filter": {"feature_type": "route_line"}}]}}},{"memoryMode":"Session","memoryName":"mapRoute"});
    -openlayers.addGeojson({"layer":"route","geojson":"{{!^JSON.stringify(memory.mapRoute.value.API.Response)}}"});
    -openlayers.zoomToLayerExtent({"layer":"route"});
</script>

<script id="getSpotPoints" type="text/ourthings">
    -api.post({"url":"{{config.api}}","body":{"_token":"{{config.token}}","schema":"adventuresyndicate","app":"map_tracker", "api": "feature_api", "action": "get_geojson", "payload": {"_filters":[{"type": "json", "data": "features", "item": "attributes", "prefix": "F", "filter": {"feature_type": "spot_tracker_points"}}]}}},{"memoryMode":"Session","memoryName":"spotPoints"});
    -openlayers.addGeojson({"layer":"spotPoints","geojson":"{{!^JSON.stringify(memory.spotPoints.value.API.Response)}}"});
    <!-- -openlayers.zoomToLayerExtent({"layer":"spotPoints"});-->
</script>

<script id="getSchools" type="text/ourthings">
    -api.post({
        "url": "{{config.api}}",
        "body":{
            "_token":"{{config.token}}",
            "schema":"adventuresyndicate",
            "app":"map_tracker",
            "api": "feature_api",
            "action": "get_geojson",
            "payload": {
                "_view": "tracker_points",
                "_filters": [
                    "{{!^memory.filterList}}"
                ]
            }
        }
    }, {
        "memoryMode":"Session","memoryName":"schoolPoints"
    });
    -openlayers.clearLayer({"layer":"schoolPoints"});
    -openlayers.addGeojson({"layer":"schoolPoints","geojson":"{{!^JSON.stringify(memory.schoolPoints.value.API.Response)}}"});
</script>

<script id="updateLoop" type="text/ourthings">
    @api.post({
        "url":"{{config.api}}",
        "body":{
            "_token":"{{config.token}}",
            "schema":"adventuresyndicate",
            "app":"map_tracker",
            "api": "feature_api",
            "action": "get_geojson",
            "payload": {
                "_view": "tracker_points",
                "_filters": [
                    "{{!^memory.filterList}}"
                ]
            }
        }
    }, {
        "memoryMode":"Session",
        "memoryName":"schoolPoints",
        "queuePrepare":"updateLoop"
    });
    -openlayers.clearLayer({"layer":"schoolPoints"});
    -openlayers.addGeojson({"layer":"schoolPoints","geojson":"{{!^JSON.stringify(memory.schoolPoints.value.API.Response)}}"});
    {{#include #getLeaders}}
    -internals.execute({"name":"updateLoop"},{"queueTimer":10000,"queueRun":"Instant"});
    @internals.execute({"name":"updateLoop"},{"queueTimer":10000,"queueRun":"Instant"});
</script>

<script id="updatePoints" type="text/ourthings">
    @api.post({
        "url":"{{config.api}}",
        "body":{
            "_token":"{{config.token}}",
            "schema":"adventuresyndicate",
            "app":"map_tracker",
            "api": "feature_api",
            "action": "get_geojson",
            "payload": {
                "_view": "tracker_points",
                "_filters": [
                    "{{!^memory.filterList}}"
                ]
            }
        }
    }, {
        "memoryMode":"Session",
        "memoryName":"schoolPoints",
        "queuePrepare":"updatePoints"
    });
    -openlayers.clearLayer({"layer":"schoolPoints"});
    -openlayers.addGeojson({"layer":"schoolPoints","geojson":"{{!^JSON.stringify(memory.schoolPoints.value.API.Response)}}"});
    {{#include #getLeaders}}
</script>